---
// Imports
import { type CollectionEntry, getCollection } from 'astro:content';

import BaseLayout from '../../layouts/BaseLayout.astro';
import ContactCTA from '../../components/ContactCTA.astro';
import Hero from '../../components/Hero.astro';
import Icon from '../../components/Icon.astro';
import Pill from '../../components/Pill.astro';

// Typage explicite des props pour TypeScript
type Props = {
  entry: CollectionEntry<'work'>;
};

export async function getStaticPaths() {
  const work = await getCollection('work');
  return work.map((entry: { slug: any; }) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

// Typage de Astro.props pour Ã©viter l'erreur "any"
const { entry } = Astro.props as Props;
const { Content, headings } = await entry.render();

// Trouver le heading entreprise (ex: ## ClioHaiti ou ## PARTNERS INSTALLATION)
const companyHeading = headings.find((h: { depth: number; }) => h.depth === 2);
const companyName = companyHeading ? companyHeading.text : '';
---

<BaseLayout description={entry.data.description}>
  <div class="stack gap-20">
    <div class="stack gap-15">
      <header>
        <div class="wrapper stack gap-2">
          <a class="back-link" href="/work/"><Icon icon="arrow-left" /> Work</a>
          <Hero title={"title" in entry.data && entry.data.title ? entry.data.title : ""} align="start">
            <div class="details">
              <div class="tags">
                {entry.data.tags.map((t: string) => <Pill>{t}</Pill>)}
              </div>
              <p class="description">{entry.data.description}</p>
              <div class="project-image-container">
                {entry.data.img && (
                  "url" in entry.data && entry.data.url ? (
                    <a href={entry.data.url} target="_blank" rel="noopener noreferrer" class="img-link">
                      <img class="project-img clickable" src={entry.data.img} alt={entry.data.img_alt || ''} />
                    </a>
                  ) : (
                    <img class="project-img" src={entry.data.img} alt={entry.data.img_alt || ''} />
                  )
                )}
              </div>
            </div>
          </Hero>
        </div>
      </header>
      <main class="wrapper">
        <div class="stack gap-10 content">
          <div class="content">
            <Content 
              headings={headings.filter((h: { depth: number; text: any; }) => !(h.depth === 2 && h.text === companyName))}
            />
          </div>
        </div>
      </main>
    </div>
    <ContactCTA />
  </div>
</BaseLayout>

<style>
header {
  padding-bottom: 2.5rem;
  border-bottom: 1px solid var(--gray-800);
}

.back-link {
  display: none;
}

.details {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  align-items: center;
}

.tags {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

.description {
  font-size: var(--text-lg);
  max-width: 54ch;
  text-align: center;
  margin-bottom: 1.5rem;
}

.project-image-container {
  width: 100%;
  display: flex;
  justify-content: center;
}

.project-img {
  margin-top: 0.5rem;
  border-radius: 1.5rem;
  box-shadow: var(--shadow-sm);
  background: var(--gradient-subtle);
  border: 1px solid var(--gray-800);
  max-width: 500px;
  width: 100%;
  height: auto;
  transition: opacity 0.3s cubic-bezier(.4,0,.2,1);
  opacity: 1;
  display: block;
}
.img-link .project-img.clickable:hover,
.img-link .project-img.clickable:focus {
  opacity: 0.7;
  cursor: pointer;
}
.img-link .project-img {
  cursor: pointer;
}

.content {
  max-width: 65ch;
  margin-inline: auto;
}
.company-info {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  gap: 2rem;
  margin-bottom: 2rem;
}
.company-name {
  font-weight: bold;
  font-size: 1.3rem;
  text-align: left;
  min-width: 180px;
}
.company-desc {
  font-size: 1.05rem;
  text-align: left;
  white-space: pre-line;
}

.content > :global(* + *) {
  margin-top: 1rem;
}

.content :global(h1),
.content :global(h2),
.content :global(h3),
.content :global(h4),
.content :global(h5) {
  margin: 1.5rem 0;
}

.content :global(img) {
  border-radius: 1.5rem;
  box-shadow: var(--shadow-sm);
  background: var(--gradient-subtle);
  border: 1px solid var(--gray-800);
}

.content :global(blockquote) {
  font-size: var(--text-lg);
  font-family: var(--font-brand);
  font-weight: 600;
  line-height: 1.1;
  padding-inline-start: 1.5rem;
  border-inline-start: 0.25rem solid var(--accent-dark);
  color: var(--gray-0);
}

.back-link,
.content :global(a) {
  text-decoration: 1px solid underline transparent;
  text-underline-offset: 0.25em;
  transition: text-decoration-color var(--theme-transition);
}

.back-link:hover,
.back-link:focus,
.content :global(a:hover),
.content :global(a:focus) {
  text-decoration-color: currentColor;
}

@media (min-width: 50em) {
  .back-link {
    display: block;
    align-self: flex-start;
  }

  .details {
    gap: 2.5rem;
  }

  .content :global(blockquote) {
    font-size: var(--text-2xl);
  }
  .company-info {
    flex-direction: row;
    align-items: flex-start;
    gap: 2rem;
  }

}
</style>